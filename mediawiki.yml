---
- name: Install MediaWiki Web Server
  hosts: all
  become: true
  vars:
    mediawiki_version: "1.41.1"
    mediawiki_major: "1.41"
    install_dir: "/var/www/html/mediawiki"
    server_name: "http://{{ ansible_default_ipv4.address }}/mediawiki"
    db_host: "{{ db_ip }}"
    db_name: "mediawiki"
    db_user: "wikiuser"

  tasks:
    - name: Install Apache and PHP
      apt:
        name:
          - apache2
          - php
          - php-mysql
          - php-xml
          - php-mbstring
          - php-intl
          - libapache2-mod-php
        state: present
        update_cache: yes

    - name: Download and Extract MediaWiki
      unarchive:
        src: "https://releases.wikimedia.org/mediawiki/{{ mediawiki_major }}/mediawiki-{{ mediawiki_version }}.tar.gz"
        dest: "/var/www/html"
        remote_src: yes
        creates: "{{ install_dir }}"

    - name: Rename directory
      command: mv /var/www/html/mediawiki-{{ mediawiki_version }} {{ install_dir }}
      args:
        creates: "{{ install_dir }}"

    - name: Fetch MediaWiki DB password from Secret Manager
      command: "gcloud secrets versions access latest --secret={{ db_pass_secret_id }}"
      register: db_password_result
      changed_when: false
      no_log: true

    - name: Run MediaWiki Installer (CLI)
      command: >
        php {{ install_dir }}/maintenance/install.php
        --dbname={{ db_name }}
        --dbuser={{ db_user }}
        --dbpass={{ db_password_result.stdout }}
        --dbserver={{ db_host }}
        --server="http://{{ public_ip }}"
        --scriptpath=/mediawiki
        --pass=AdminPass123
        "MyWiki" "AdminUser"
      args:
        creates: "{{ install_dir }}/LocalSettings.php"

    - name: Set Permissions
      file:
        path: "{{ install_dir }}"
        owner: www-data
        group: www-data
        recurse: yes
      notify: Restart Apache

    - name: Add Google Cloud Ops Agent repository
      shell: |
        curl -sSO https://dl.google.com/cloudagents/add-google-cloud-ops-agent-repo.sh
        bash add-google-cloud-ops-agent-repo.sh --also-install
      args:
        creates: /etc/apt/sources.list.d/google-cloud-ops-agent.list
      changed_when: false

    - name: Configure Ops Agent for Apache
      copy:
        dest: /etc/google-cloud-ops-agent/config.yaml
        content: |
          logging:
            receivers:
              apache_access:
                type: files
                include_paths:
                  - /var/log/apache2/access.log
              apache_error:
                type: files
                include_paths:
                  - /var/log/apache2/error.log
            service:
              pipelines:
                default_pipeline:
                  receivers: [apache_access, apache_error]
      notify: Restart Ops Agent

  handlers:
    - name: Restart Ops Agent
      service:
        name: google-cloud-ops-agent
        state: restarted

    - name: Restart Apache
      service:
        name: apache2
        state: restarted